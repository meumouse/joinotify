!function(t){"use strict";const e=window.joinotify_builder_params||{},o={purchasedProducts:[],conditionType:"",isConditionAction:!1,getActionID:"",nextActionID:"",triggerTabs:function(){t(document).ready((function(){setTimeout((()=>{t(".joinotify-triggers-tab-wrapper a.nav-tab").first().click()}),500)})),t(document).on("click",".joinotify-triggers-tab-wrapper a.nav-tab",(function(){let e=t(this).attr("href");t(".joinotify-triggers-tab-wrapper a.nav-tab").removeClass("nav-tab-active"),t(".triggers-content-wrapper .nav-content").removeClass("active"),t(this).addClass("nav-tab-active"),t(".triggers-content-wrapper").find(e).addClass("active")}))},keepButtonState:function(t){var e=t.width(),o=t.height(),i=t.html();return t.width(e),t.height(o),{width:e,height:o,html:i}},selectCondition:function(){t(document).on("click",".condition-item",(function(){var e=t(this).data("condition");t(".condition-item").removeClass("active"),t(".condition-settings-item").removeClass("active"),t(this).toggleClass("active"),t('.condition-settings-item[data-condition="'+e+'"]').addClass("active"),t(".condition-item").hasClass("active")?t("#add_action_condition").prop("disabled",!1):t("#add_action_condition").prop("disabled",!0),t(".condition-settings-item .required-setting").removeClass("required-setting"),t('.condition-settings-item[data-condition="'+e+'"]').find("select, input, textarea").each((function(){"true"===t(this).attr("data-original-required")&&t(this).addClass("required-setting")})),o.enableAddActionButton()}))},resetActionSettings:function(){var e=t(".offcanvas");e.find(".set-time-delay-type option:first").attr("selected","selected"),e.find(".get-wait-value").val(""),e.find(".get-wait-period option:first").attr("selected","selected"),e.find(".get-date-value").val(""),e.find(".get-time-value").val(""),e.find(".get-whatsapp-receiver").val(""),e.find(".get-whatsapp-media-url").val(""),e.find(".condition-item.active").removeClass("active"),e.find(".condition-settings-item.active").removeClass("active"),e.find(".joinotify_condition_node_point").removeClass("active"),e.find(".get-condition-type").each((function(){t(this).find("option:first").attr("selected","selected")})),e.find(".get-condition-value").each((function(){t(this).find("option:first").attr("selected","selected")||t(this).val("")}));let o=t("#offcanvas_snippet_php").find(".joinotify-code-editor").next(".CodeMirror").get(0).CodeMirror;o&&o.setValue("<?php\n\n"),e.find(".generate-coupon-code").prop("checked",!1),e.find(".set-coupon-code").val(""),e.find(".set-coupon-description").val(""),e.find(".set-coupon-discount-type option:first").attr("selected","selected"),e.find(".set-coupon-discount-value").val(""),e.find(".allow-free-shipping").prop("checked",!1),e.find(".set-expires-coupon").prop("checked",!1)},uploadWorkflowTemplates:function(){t("#joinotify_import_file_zone").on("dragover dragleave",(function(e){e.preventDefault(),t(this).toggleClass("drag-over","dragover"===e.type)})),t("#joinotify_import_file_zone").on("drop",(function(e){e.preventDefault();var i=e.originalEvent.dataTransfer.files[0];t(this).hasClass("file-uploaded")||o.importWorkflow(i,t(this))})),t("#upload_template_file").on("change",(function(e){var i=e.target.files[0];o.importWorkflow(i,t(this).parents(".dropzone"))}))},importWorkflow:function(i,n){if(i){var a=i.name,s=new FormData;s.append("action","joinotify_import_workflow_templates"),s.append("security",e.nonces.import_nonce),s.append("file",i),a&&n.find(".file-list").removeClass("d-none").text(a),n.addClass("file-processing"),t("#joinotify_send_import_files").prop("disabled",!1),t("#joinotify_send_import_files").on("click",(function(i){i.preventDefault();let a=t(this);var d=o.keepButtonState(a);t.ajax({url:e.ajax_url,type:"POST",data:s,processData:!1,contentType:!1,beforeSend:function(){a.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(t){e.debug_mode&&console.log(t);try{"success"===t.status?(a.prop("disabled",!0),n.addClass("file-uploaded").removeClass("file-processing"),n.children(".spinner-border").remove(),n.append('<div class="upload-notice d-flex flex-column align-items-center"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="#22c55e" d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path fill="#22c55e" d="M9.999 13.587 7.7 11.292l-1.412 1.416 3.713 3.705 6.706-6.706-1.414-1.414z"></path></svg><span>'+t.dropfile_message+"</span></div>"),n.children(".file-list").addClass("d-none"),o.displayToast("success",t.toast_header_title,t.toast_body_title),setTimeout((()=>{window.location.href=t.redirect}),1e3)):(n.addClass("invalid-file").removeClass("file-processing"),n.children(".drag-text").removeClass("d-none"),n.children(".drag-and-drop-file").removeClass("d-none"),n.children(".upload-license-key").removeClass("d-none"),n.find(".file-list").addClass("d-none"),o.displayToast("error",t.toast_header_title,t.toast_body_title))}catch(t){console.log(t)}},error:function(t,e,o){n.addClass("fail-upload").removeClass("file-processing"),console.log("Error on upload file"),console.log(t.responseText)},complete:function(){a.prop("disabled",!1).html(d.html)}})}))}else t("#joinotify_send_import_files").prop("disabled",!0)},sidebarActions:function(){o.openSidebar(),o.closeSidebar(),o.expandSidebar()},openSidebar:function(){const e=t("#joinotify_actions_group");t(document).on("click",".funnel_add_action",(function(){let i=t(this),n=i.hasClass("waiting-action");if(t(".funnel_add_action").not(i).removeClass("waiting-action").find(".plusminus").removeClass("active"),n)return i.removeClass("waiting-action"),i.find(".plusminus").removeClass("active"),e.removeClass("active"),t("#joinotify_builder_funnel").removeClass("waiting-select-action"),void t(".joinotify_condition_node_point").removeClass("active");if(i.addClass("waiting-action"),i.find(".plusminus").addClass("active"),o.nextActionID="",i.hasClass("between-action-connector")){let t=i.closest(".funnel_block_item_connector").nextAll(".funnel-action-item").first();t.length&&(o.nextActionID=t.data("action-id"))}o.conditionType=i.data("condition"),"condition"===i.data("action")?(e.hasClass("active")||(e.addClass("active"),t("#joinotify_builder_funnel").addClass("waiting-select-action")),o.isConditionAction=!0,o.getActionID=i.data("action-id"),t(".joinotify_condition_node_point").removeClass("active"),i.parent(".add_condition_inside_node_point").parent(".joinotify_condition_node_point").addClass("active"),t('.action-item[data-action="time_delay"]').addClass("locked"),t('.action-item[data-action="condition"]').addClass("locked")):(e.addClass("active"),o.isConditionAction=!1,o.getActionID="",t(".joinotify_condition_node_point").removeClass("active"),t('.action-item[data-action="time_delay"]').removeClass("locked"),t('.action-item[data-action="condition"]').removeClass("locked"),t("#joinotify_builder_funnel").addClass("waiting-select-action"))}))},closeSidebar:function(){t(document).on("click","#joinotify_close_actions_group",(function(e){e.preventDefault();let i=t("#joinotify_actions_group");i.removeClass("active"),t(".joinotify_condition_node_point").removeClass("active"),t(".plusminus.active").removeClass("active"),t(".funnel_add_action.waiting-action").removeClass("waiting-action"),o.nextActionID="",i.hasClass("active")?t("#joinotify_builder_funnel").addClass("waiting-select-action"):(t("#joinotify_builder_funnel").removeClass("waiting-select-action"),o.isConditionAction=!1,t(".action-item.locked").removeClass("locked"))}))},expandSidebar:function(){t(document).on("click",".expand-offcanvas",(function(e){e.preventDefault(),t(this).addClass("d-none"),t(this).siblings(".collapse-offcanvas").removeClass("d-none"),t(".offcanvas.show").addClass("offcanvas-expanded"),t("#joinotify_builder_funnel").addClass("offcanvas-expanded")})),t(document).on("click",'.btn-close[data-bs-dismiss="offcanvas"], .collapse-offcanvas',(function(){t(this).siblings(".expand-offcanvas").removeClass("d-none"),t(this).siblings(".collapse-offcanvas").addClass("d-none"),t(this).closest(".collapse-offcanvas").addClass("d-none"),t(".offcanvas.offcanvas-expanded").removeClass("offcanvas-expanded"),t("#joinotify_builder_funnel").removeClass("offcanvas-expanded")}))},displayToast:function(e,o,i){var n="",a="",s="";"success"===e?(n="toast-success",a="bg-success text-white",s='<svg class="icon icon-white me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M9.999 13.587 7.7 11.292l-1.412 1.416 3.713 3.705 6.706-6.706-1.414-1.414z"></path></svg>'):"error"===e?(n="toast-danger",a="bg-danger text-white",s='<svg class="icon icon-white me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M11 11h2v6h-2zm0-4h2v2h-2z"></path></svg>'):"warning"===e?(n="toast-warning",a="bg-warning text-white",s='<svg class="icon icon-white me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M11 11h2v6h-2zm0-4h2v2h-2z"></path></svg>'):(n="toast-secondary",a="bg-secondary text-white",s="");var d="toast-"+Math.random().toString(36).substr(2,9),r=`<div id="${d}" class="toast ${n} show">\n\t\t\t\t<div class="toast-header ${a}">\n\t\t\t\t\t\t${s}\n\t\t\t\t\t\t<span class="me-auto">${o}</span>\n\t\t\t\t\t\t<button class="btn-close btn-close-white ms-2 hide-toast" type="button" data-bs-dismiss="toast" aria-label="Close"></button>\n\t\t\t\t</div>\n\t\t\t\t<div class="toast-body">${i}</div>\n\t\t\t</div>`;t("#joinotify-automations-builder").prepend(r),setTimeout((()=>{jQuery("#"+d).fadeOut("fast")}),3e3),setTimeout((()=>{jQuery("#"+d).remove()}),3500)},initBootstrapComponents:function(){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((t=>new bootstrap.Tooltip(t)));t(document).on("click",'button[data-bs-toggle="modal"], a[data-bs-toggle="modal"]',(function(e){e.preventDefault();let o=t(this).attr("data-bs-target"),i=t(o).detach();t("#wpcontent").prepend(i)}))},getParamByName:function(t){let e=window.location.href;t=t.replace(/[\[\]]/g,"\\{text}");let o=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null},addQueryParam:function(t,e){var o=new URL(window.location.href);o.searchParams.set(t,e),window.history.pushState({},"",o)},correctTriggerSettingsModal:function(){t(".joinotify-trigger-details").each((function(){t(this).detach().insertAfter("#wpadminbar")}))},adjustHeightCondition:function(){t(".funnel-trigger-group .funnel_block_item_condition").each((function(){var e=t(this),o=e.find(".add_condition_inside_node_point.condition_false"),i=e.find(".add_condition_inside_node_point.condition_true"),n=e.find(".end_condition_wrapper"),a=o.length>0?o.outerHeight(!0):0,s=i.length>0?i.outerHeight(!0):0,d=Math.max(a,s),r=`calc(1rem + ${d}px)`,l=`calc(${d}px - 100px)`;e.css("height",r),n.css("height",l)}))},validateInputCurrency:function(){t(document).on("input",".format-currency",(function(){let e=t(this),o=e.val();o=o.replace(/[^0-9,]/g,"");let i=o.split(",");i.length>2&&(o=i[0]+","+i.slice(1).join("")),o=o.replace(/^0+(?=\d)/,"");let n=i[0].replace(/\B(?=(\d{3})+(?!\d))/g,".")+(void 0!==i[1]?","+i[1]:"");e.val(n)})),t(document).on("keypress",".format-currency",(function(t){let e=String.fromCharCode(t.which);/[0-9,]/.test(e)||t.preventDefault()}))},enableAddTriggerButton:function(){function o(){let e=t("#joinotify_set_workflow_name").val(),o=t(".trigger-item.active").data("trigger"),i=t("#joinotify_proceed_step_funnel");""!==e&&o?i.prop("disabled",!1):i.prop("disabled",!0)}t("#joinotify_set_workflow_name").val(e.i18n.default_workflow_name),t(document).on("change input","#joinotify_set_workflow_name",(function(){t(this).val();o()})),t(document).on("click",".trigger-item",(function(){t(this).hasClass("require-plugins")||(t(".trigger-item").removeClass("active"),t(this).toggleClass("active"),o())}))},addTrigger:function(){o.enableAddTriggerButton(),t(document).on("click","#joinotify_proceed_step_funnel",(function(i){i.preventDefault();var n=t("#joinotify_set_workflow_name").val(),a=o.getParamByName("id");let s=t(this);var d=o.keepButtonState(s);t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_create_workflow",title:n,context:t(".trigger-item.active").data("context"),trigger:t(".trigger-item.active").data("trigger"),post_id:a},beforeSend:function(){s.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status&&!0===i.proceed?(a?t("#joinotify_workflow_status").replaceWith(i.workflow_status):(o.addQueryParam("id",i.post_id),a=i.post_id,t("#joinotify_workflow_header_title_container").append(i.workflow_status)),t("#joinotify_actions_wrapper").html(i.sidebar_actions),t("#offcanvas_condition").find(".offcanvas-body").html(i.condition_selectors),t("#offcanvas_send_whatsapp_message_text").find(".offcanvas-body").append(i.fetch_groups_trigger),t("#offcanvas_send_whatsapp_message_text").find(".offcanvas-body").append(i.placeholders_list),t("#offcanvas_send_whatsapp_message_media").find(".offcanvas-body").append(i.fetch_groups_trigger),t("#send_whatsapp_message_media").find(".offcanvas-body").append(i.placeholders_list),t("#add_action_condition").prop("disabled",!0),t("#joinotify_triggers_group").removeClass("active"),t("#joinotify_triggers_content").removeClass("active"),t("#joinotify_workflow_status_switch").prop("disabled",!1),t("#joinotify_workflow_title").text(n),t("#joinotify_edit_workflow_title").val(n),document.title=n,t("#joinotify_builder_funnel").children(".funnel-trigger-group").html(i.workflow_content),setTimeout((()=>{if(i.active_settings_modal){let e=i.active_settings_modal,o=t(e).detach();t("#wpcontent").prepend(o),t(e).modal("show")}}),1e3),t(document).trigger("workflowReady"),o.displayToast("success",i.toast_header_title,i.toast_body_title)):o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}},complete:function(){s.prop("disabled",!1).html(d.html)}})}))},enableAddActionButton:function(){var e="";function o(){let o=!0;t(".offcanvas.show .required-setting").each((function(){const e=t(this);e.is("input")||e.is("textarea")?""===e.val().trim()&&(o=!1):e.is("select")&&"none"===e.val()&&(o=!1)})),o?t(e).prop("disabled",!1):t(e).prop("disabled",!0)}t(document).on("click",".action-item",(function(){setTimeout((()=>{e=t(".offcanvas.show").find(".add-funnel-action")}),500)})),t(".condition-settings-item .required-setting").each((function(){t(this).attr("data-original-required","true")})),t(document).on("change input blur keyup",".required-setting",(function(){o()})),t(document).on("click",".validate-required-settings, .condition-item",(function(){setTimeout((()=>{o()}),10)})),setTimeout((()=>{t("#add_action_stop_funnel").prop("disabled",!1)}),500)},getActionData:function(e,i){var n={},a=t(i);const s=a.find(".offcanvas-title, .modal-title").text();switch(e){case"time_delay":n={type:"action",data:{action:"time_delay",title:s,delay_type:d=a.find(".set-time-delay-type, .set-time-delay-type-edit").val()}},"period"===d?(n.data.delay_value=a.find(".get-wait-value").val(),n.data.delay_period=a.find(".get-wait-period").val()):"date"===d&&(n.data.date_value=a.find(".get-date-value").val(),n.data.time_value=a.find(".get-time-value").val());break;case"send_whatsapp_message_text":n={type:"action",data:{action:"send_whatsapp_message_text",title:s,sender:a.find(".get-whatsapp-phone-sender").val(),receiver:a.find(".get-whatsapp-receiver").val(),message:a.find(".set-whatsapp-message-text").val()}};break;case"send_whatsapp_message_media":n={type:"action",data:{action:"send_whatsapp_message_media",title:s,sender:a.find(".get-whatsapp-phone-sender").val(),receiver:a.find(".get-whatsapp-receiver").val(),media_type:a.find(".get-whatsapp-media-type").val(),media_url:a.find(".get-whatsapp-media-url").val(),caption:a.find(".set-whatsapp-message-caption").val()}};break;case"condition":let e=a.find(".condition-item.active").data("condition")||a.find(".get-condition").val(),i=a.find(".condition-settings-item.active .get-condition-type option:selected").val()||a.find(".get-condition-type option:selected").val();if(n={type:"action",data:{action:"condition",title:a.find(".condition-item.active .title").text()||a.find(".get-condition-title").val(),condition_content:{condition:e,type:i,type_text:a.find(".condition-settings-item.active .get-condition-type option:selected").text()||a.find(".get-condition-type option:selected").text(),value:a.find(".condition-settings-item.active .get-condition-value option:selected").val()||a.find(".condition-settings-item.active .get-condition-value").val()||a.find(".get-condition-value").val(),value_text:a.find(".condition-settings-item.active .get-condition-value option:selected").text()||a.find(".condition-settings-item.active .get-condition-value").val()||a.find(".get-condition-value option:selected").text()||a.find(".get-condition-value").text()||a.find(".get-condition-value").val()}}},"products_purchased"===e){let e=t(".search-products"),i=[];if(e.length){let t=e.attr("data-selected-products");try{i=JSON.parse(t)}catch(t){console.error("Error parsing data-selected-products:",t)}}n.data.condition_content.products=n.data.condition_content.products?.length?n.data.condition_content.products:o.purchasedProducts&&o.purchasedProducts.length?o.purchasedProducts:i,n.data.condition_content.value=""}else"user_meta"===e?(n.data.condition_content.meta_key=a.find(".meta-key-wrapper").children(".get-condition-value").val(),"empty"===i||"not_empty"===i?n.data.condition_content.value="":(n.data.condition_content.value=a.find(".condition-settings-item.active .meta-value-wrapper .get-condition-value").val()||a.find(".meta-value-wrapper").children(".get-condition-value").val(),n.data.condition_content.value_text=a.find(".condition-settings-item.active .meta-value-wrapper .get-condition-value").val()||a.find(".meta-value-wrapper").children(".get-condition-value").val())):"field_value"===e&&(n.data.condition_content.field_id=a.find(".condition-settings-item.active .field-id-wrapper .get-condition-value").val()||a.find(".field-id-wrapper").children(".get-condition-value").val(),"empty"===i||"not_empty"===i?n.data.condition_content.value="":(n.data.condition_content.value=a.find(".condition-settings-item.active .field-value-wrapper .get-condition-value").val()||a.find(".field-value-wrapper").children(".get-condition-value").val(),n.data.condition_content.value_text=a.find(".condition-settings-item.active .field-value-wrapper .get-condition-value").val()||a.find(".field-value-wrapper").children(".get-condition-value").val()));break;case"stop_funnel":n={type:"action",data:{action:"stop_funnel"}};break;case"snippet_php":n={type:"action",data:{action:"snippet_php",title:s,snippet_php:a.find(".joinotify-code-editor").val()}};break;case"create_coupon":var d=a.find(".set-time-delay-type").val();n={type:"action",data:{action:"create_coupon",title:s,settings:{generate_coupon:a.find(".generate-coupon-code").prop("checked")?"yes":"no",coupon_code:a.find(".set-coupon-code").val()||"",coupon_description:a.find(".set-coupon-description").val(),discount_type:a.find(".set-coupon-discount-type").val(),coupon_amount:a.find(".set-coupon-discount-value").val(),free_shipping:a.find(".allow-free-shipping").prop("checked")?"yes":"no",coupon_expiry:a.find(".set-expires-coupon").prop("checked")?"yes":"no",expiry_data:{type:d||""},message:{sender:a.find(".get-whatsapp-phone-sender").val(),receiver:a.find(".get-whatsapp-receiver").val(),message:a.find(".set-whatsapp-message-text").val()}}}},"period"===d?(n.data.settings.expiry_data.delay_value=a.find(".get-wait-value").val(),n.data.settings.expiry_data.delay_period=a.find(".get-wait-period").val()):"date"===d&&(n.data.settings.expiry_data.date_value=a.find(".get-date-value").val(),n.data.settings.expiry_data.time_value=a.find(".get-time-value").val())}return n},addAction:function(){o.selectCondition(),o.enableAddActionButton(),t(document).on("click",".add-funnel-action",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n),s=o.getParamByName("id"),d=n.data("action"),r=o.getActionData(d,".offcanvas.show");e.debug_mode&&(console.log(r),console.log("Post ID: ",s)),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_add_workflow_action",post_id:s,action_condition:o.isConditionAction,action_id:o.getActionID,condition_action:o.conditionType,next_action_id:o.nextActionID,workflow_action:JSON.stringify(r)},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?(t(".offcanvas.show").removeClass("show"),n.prop("disabled",!0),o.resetActionSettings(),i.has_action?t("#joinotify_builder_run_test").prop("disabled",!1):t("#joinotify_builder_run_test").prop("disabled",!0),t("#joinotify_builder_funnel").children(".funnel-trigger-group").html(i.workflow_content),t(document).trigger("updatedWorkflow"),o.displayToast("success",i.toast_header_title,i.toast_body_title)):o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}},complete:function(){o.adjustHeightCondition(),n.html(a.html),t("#joinotify_actions_group").removeClass("active"),t(".condition-item.active").removeClass("active"),t("#add_action_condition").prop("disabled",!0),t("#joinotify_builder_funnel").removeClass("waiting-select-action")}})}))},removeAction:function(){let i=[];t(document).on("click",".exclude-action",(function(n){if(n.preventDefault(),!confirm(e.i18n.confirm_exclude_action))return;var a=t(this);let s=a.data("action-id"),d=t('.funnel-action-item[data-action-id="'+s+'"]');i.push(s),d.addClass("placeholder-wave removing-action"),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_delete_workflow_action",post_id:o.getParamByName("id"),action_id:a.data("action-id")},beforeSend:function(){a.prop("disabled",!0),a.closest(".funnel-action-item").addClass("placeholder-wave removing-action")},success:function(n){e.debug_mode&&console.log(n);try{"success"===n.status?(n.has_action?t("#joinotify_builder_run_test").prop("disabled",!1):t("#joinotify_builder_run_test").prop("disabled",!0),t("#joinotify_builder_funnel").children(".funnel-trigger-group").html(n.workflow_content),i.forEach((e=>{t('.funnel-action-item[data-action-id="'+e+'"]').addClass("placeholder-wave removing-action")})),o.nextActionID="",t(document).trigger("updatedWorkflow"),o.displayToast("success",n.toast_header_title,n.toast_body_title)):o.displayToast("error",n.toast_header_title,n.toast_body_title)}catch(t){console.log(t)}},complete:function(){i=i.filter((t=>t!==s)),i.includes(s)||d.removeClass("placeholder-wave removing-action"),a.prop("disabled",!1),o.adjustHeightCondition()}})}))},changeWorkflowStatus:function(){t(document).on("click","#joinotify_workflow_status_switch",(function(){let i=t(this);t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_update_workflow_status",status:i.prop("checked")?"publish":"draft",post_id:o.getParamByName("id")},beforeSend:function(){i.prop("disabled",!0)},complete:function(){i.prop("disabled",!1)},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?(t("#joinotify_workflow_status_title").text(i.workflow_status),t("#joinotify_workflow_status").replaceWith(i.display_workflow_status),o.displayToast("success",i.toast_header_title,i.toast_body_title)):o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}}})}))},loadWorkflowData:function(){var i=o.getParamByName("id");i&&t.ajax({url:e.ajax_url,type:"POST",data:{action:"joinotify_load_workflow_data",post_id:i},beforeSend:function(){t(".joinotify-loader-container").removeClass("d-none")},success:function(i){e.debug_mode&&console.log(i);try{if("success"===i.status){if(t("#joinotify_choose_template_container").removeClass("active"),t("#joinotify_builder_navbar").addClass("active"),i.has_trigger?(t("#joinotify_triggers_group").removeClass("active"),t("#joinotify_triggers_content").removeClass("active")):(t("#joinotify_triggers_group").addClass("active"),t("#joinotify_triggers_content").addClass("active")),i.has_action?t("#joinotify_builder_run_test").prop("disabled",!1):t("#joinotify_builder_run_test").prop("disabled",!0),t("#joinotify_actions_wrapper").html(i.sidebar_actions),t("#offcanvas_send_whatsapp_message_text").find(".offcanvas-body").append(i.fetch_groups_trigger),t("#offcanvas_send_whatsapp_message_text").find(".offcanvas-body").append(i.placeholders_list),t("#offcanvas_send_whatsapp_message_media").find(".offcanvas-body").append(i.fetch_groups_trigger),t("#send_whatsapp_message_media").find(".offcanvas-body").append(i.placeholders_list),t("#add_action_condition").prop("disabled",!0),t("#joinotify_workflow_title").text(i.workflow_title),t("#joinotify_edit_workflow_title").val(i.workflow_title),t("#joinotify_set_workflow_name").val(i.workflow_title),document.title=i.workflow_title,t("#joinotify_workflow_header_title_container").append(i.display_workflow_status),t("#joinotify_builder_funnel .funnel-trigger-group").prepend(i.workflow_data),t("#joinotify_workflow_status_switch").prop("disabled",!1),"publish"===i.workflow_status&&(t("#joinotify_workflow_status_switch").prop("checked",!0),t("#joinotify_workflow_status_title").text(e.i18n.status_active)),t("#joinotify_builder_funnel").children(".funnel-trigger-group").html(i.workflow_content),t("#offcanvas_condition").find(".offcanvas-body").html(i.condition_selectors),i.active_settings_modal){let e=i.active_settings_modal,o=t(e).detach();t("#wpcontent").prepend(o),t(e).modal("show")}t(document).trigger("workflowReady"),t(".funnel-trigger-item").length>0&&t(".funnel-trigger-item").each((function(){var e=t(this).data("context"),o=t(this).data("trigger"),i=t('.trigger-item[data-context="'+e+'"][data-trigger="'+o+'"]');i.length>0&&i.addClass("active")}))}else o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}},complete:function(){t(".joinotify-loader-container").addClass("d-none"),o.adjustHeightCondition()},error:function(t,e,o){console.error("Error on AJAX request:",t.responseText)}})},updateWorkflowTitle:function(){t(document).on("click","#joinotify_update_workflow_title",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n);t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_update_workflow_title",post_id:o.getParamByName("id"),workflow_title:t("#joinotify_edit_workflow_title").val()},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?(t("#joinotify_workflow_title").text(i.workflow_title),t("#joinotify_edit_workflow_title").val(i.workflow_title),t("#joinotify_set_workflow_name").val(i.workflow_title),document.title=i.workflow_title,t("#edit_workflow_title").find(".btn-close").click(),o.displayToast("success",i.toast_header_title,i.toast_body_title)):(t("#edit_workflow_title").find(".btn-close").click(),t("#joinotify_edit_workflow_title").val(""),o.displayToast("error",i.toast_header_title,i.toast_body_title))}catch(t){console.log(t)}},complete:function(){n.prop("disabled",!1).html(a.html)}})}))},changeVisibilityForTimeDelay:function(){t(document).on("change",".set-time-delay-type",(function(){var e=t(this),o=e.val();e.parent("div").siblings(".wait-time-period-container").toggleClass("d-none","period"!==o),e.parent("div").siblings(".wait-time-period-container").find(".get-wait-value").toggleClass("required-setting","period"===o),e.parent("div").siblings(".wait-date-container").toggleClass("d-none","date"!==o),e.parent("div").siblings(".wait-date-container").find(".get-date-value").toggleClass("required-setting","date"===o)})),setTimeout((()=>{t(".set-time-delay-type").each((function(){var e=t(this),o=e.val();e.parent("div").siblings(".wait-time-period-container").toggleClass("d-none","period"!==o),e.parent("div").siblings(".wait-time-period-container").find(".get-wait-value").toggleClass("required-setting","period"===o),e.parent("div").siblings(".wait-date-container").toggleClass("d-none","date"!==o),e.parent("div").siblings(".wait-date-container").find(".get-date-value").toggleClass("required-setting","date"===o)}))}),500)},changeVisibilityForCouponCode:function(){function e(t){var e=t.prop("checked");t.parent("div").siblings(".coupon-code-wrapper").toggleClass("d-none",e).find(".set-coupon-code").toggleClass("required-setting",!e)}function o(t){var e=t.prop("checked"),o=t.parent("div").siblings(".select-time-delay-container").find(".set-time-delay-type");t.parent("div").siblings(".select-time-delay-container").toggleClass("d-none",!e),"period"===o.val()?t.parent("div").siblings(".wait-time-period-container").toggleClass("d-none",!e).find(".get-wait-value").toggleClass("required-setting",e):"date"===o.val()&&t.parent("div").siblings(".wait-date-container").toggleClass("d-none",!e).find(".get-date-value").toggleClass("required-setting",e)}t(document).on("change",".generate-coupon-code",(function(){e(t(this))})),t(document).on("change",".set-expires-coupon",(function(){o(t(this))})),setTimeout((()=>{t("#offcanvas_create_coupon").find(".wait-time-period-container").addClass("d-none"),t("#offcanvas_create_coupon").find(".get-wait-value").removeClass("required-setting"),t(".generate-coupon-code").each((function(){e(t(this))})),t(".set-expires-coupon").each((function(){o(t(this))}))}),600)},changeVisibilityForConditions:function(){function e(t){var e=t.val();"empty"===e||"not_empty"===e?t.parent("div").siblings(".meta-value-wrapper, .field-value-wrapper").addClass("d-none").children(".get-condition-value").removeClass("required-setting"):t.parent("div").siblings(".meta-value-wrapper, .field-value-wrapper").removeClass("d-none").children(".get-condition-value").addClass("required-setting")}t(document).on("change",".get-condition-type",(function(){e(t(this))})),setTimeout((()=>{t(".get-condition-type").each((function(){e(t(this))}))}),600)},changeVisibilityForElements:function(){o.changeVisibilityForTimeDelay(),o.changeVisibilityForCouponCode(),o.changeVisibilityForConditions()},initDatePicker:function(){t(".dateselect").datepicker({format:"dd/mm/yyyy",todayHighlight:!0,language:"pt-BR"}).on("changeDate",(function(){t(this).datepicker("hide")})),t(document).on("focus",".dateselect",(function(e){t(this).data("datepicker")||t(this).datepicker({format:"dd/mm/yyyy",todayHighlight:!0,language:"pt-BR"}),t(e.target).closest(".dateselect").length||t(".dateselect").datepicker("hide")}))},formatWhatsAppText:function(t){return t=(t=(t=t.replace(/```([^`]+)```/g,'<span style="font-family: monospace;">$1</span>').replace(/(?<=\s|^)\*\*([^\s*][^*]+?[^\s*])\*\*(?=\s|$)/g,'<span style="font-weight: bold;">$1</span>').replace(/(?<=\s|^)\*([^\s*][^*]+?[^\s*])\*(?=\s|$)/g,'<span style="font-weight: bold;">$1</span>').replace(/(?<=\s|^)_([^\s_][^_]+?[^\s_])_(?=\s|$)/g,'<span style="font-style: italic;">$1</span>').replace(/(?<=\s|^)~([^\s~][^~]+?[^\s~])~(?=\s|$)/g,'<span style="text-decoration: line-through;">$1</span>')).replace(/\n/g,"<br>")).replace(/{{ br }}/g,"<br>")},whatsappMessagePreview:function(){t(document).on("input change blur keyup",".set-whatsapp-message-text",(function(){var e=t(this).val(),i=t(this).parent("div").siblings(".preview-whatsapp-message-sender"),n=o.formatWhatsAppText(e);""!==n.trim()?i.addClass("active").html(n):i.removeClass("active").html("")}))},downloadData:function(t,e,o){var i=new Blob([t],{type:o}),n=document.createElement("a"),a=URL.createObjectURL(i);n.href=a,n.download=e,document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),window.URL.revokeObjectURL(a)}),0)},exportWorkflow:function(){t("#joinotify_export_workflow").on("click",(function(i){i.preventDefault();const n=o.getParamByName("id");t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_export_workflow",post_id:n,security:e.nonces.export_nonce},dataType:"json",beforeSend:function(){t(".joinotify-loader-container").removeClass("d-none").addClass("exporting-workflow")},complete:function(){t(".joinotify-loader-container").addClass("d-none").removeClass("exporting-workflow")},success:function(t){try{if("success"===t.status){var e=`joinotify-workflow-${n}.json`;o.downloadData(JSON.stringify(t.export_data,null,2),e,"application/json"),o.displayToast("success",t.toast_header_title,t.toast_body_title)}else o.displayToast("error",t.toast_header_title,t.toast_body_title)}catch(t){console.error(t)}},error:function(t,e,o){alert("AJAX error: "+o)}})}))},workflowSteps:function(){t(document).on("click",".choose-template",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n),s=n.data("template");if(n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>'),setTimeout((()=>{n.prop("disabled",!1).html(a.html)}),1e3),"scratch"===s)setTimeout((()=>{t("#joinotify_start_choose_container").removeClass("active"),t("#joinotify_choose_template_container").removeClass("active"),t("#joinotify_triggers_group").addClass("active"),t("#joinotify_triggers_content").addClass("active"),t("#joinotify_builder_navbar").addClass("active")}),1e3);else if("template"===s){let i=t("#joinotify_template_library_container");setTimeout((()=>{t("#joinotify_start_choose_container").removeClass("active slide-left-animation").addClass("slide-right-animation"),i.addClass("active slide-left-animation").removeClass("slide-right-animation")}),1e3),i.hasClass("templates-loaded")||t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_get_workflow_templates"},success:function(n){e.debug_mode&&console.log(n);try{"success"===n.status?(t(".joinotify-templates-group").html(n.template_html),i.addClass("templates-loaded").removeClass("templates-counted")):o.displayToast("error",n.toast_header_title,n.toast_body_title)}catch(t){console.log(t)}},error:function(t){console.error(t)}})}else"import"===s&&setTimeout((()=>{t("#joinotify_start_choose_container").removeClass("active slide-left-animation").addClass("slide-right-animation"),t("#joinotify_import_template_container").addClass("active slide-left-animation").removeClass("slide-right-animation")}),1e3)})),t(document).on("click",".return-to-start",(function(e){e.preventDefault(),t("#joinotify_triggers_group").removeClass("active"),t("#joinotify_triggers_content").removeClass("active"),t("#joinotify_builder_navbar").removeClass("active"),t("#joinotify_template_library_container").removeClass("active"),t("#joinotify_choose_template_container").addClass("active"),t("#joinotify_start_choose_container").addClass("active")})),t(document).on("click","#joinotify_cancel_import_template",(function(e){e.preventDefault(),t("#joinotify_import_template_container").removeClass("active"),t("#joinotify_start_choose_container").addClass("active")}))},downloadTemplates:function(){t(document).on("click",".download-template",(function(i){i.preventDefault();let n=t(this),a=o.keepButtonState(n),s=n.data("file");n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>'),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_download_workflow_template",security:e.nonces.import_nonce,file:s},success:function(i){e.debug_mode&&console.log(i),n.html(a.html),"success"===i.status?(t(".download-template").each((function(){t(this).prop("disabled",!0)})),o.displayToast("success",i.toast_header_title,i.toast_body_title),window.location.href=i.redirect):o.displayToast("error",i.toast_header_title,i.toast_body_title)},error:function(t){console.error(t),n.prop("disabled",!1).html(a.html)}})}))},filterWorkflowTemplates:function(){let o=t("#joinotify_search_workflows"),i=t("#joinotify_filter_library_categories");function n(){let n=o.val().toLowerCase().trim(),a=i.val(),s=0;t(".joinotify-templates-group .template-item").each((function(){let e=t(this),o=e.find(".title").text().toLowerCase(),i=e.data("category");(""===n||o.includes(n))&&("all"===a||i===a)?(e.removeClass("d-none"),s++):e.addClass("d-none")})),t(".no-templates-message").remove(),0===s&&t(".joinotify-templates-group").append(`<div class="no-templates-message text-center text-muted mt-4">${e.i18n.not_templates_found}</div>`)}o.on("input",(function(){n()})),i.on("change",(function(){n()}))},openMediaLibrary:function(){var o;t(document).on("click",".set-media-url",(function(i){i.preventDefault();let n=t(this);o||(o=wp.media.frames.file_frame=wp.media({title:e.i18n.set_media_title,button:{text:e.i18n.use_this_media_title},multiple:!1})).on("select",(function(){var t=o.state().get("selection").first().toJSON().url;n.siblings(".get-media-url").val(t).trigger("change")})),o.open()}))},runTestWorkflow:function(){t(document).on("click","#joinotify_builder_run_test",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n);t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_run_workflow_test",post_id:o.getParamByName("id")},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(t){e.debug_mode&&console.log(t);try{"success"===t.status?o.displayToast("success",t.toast_header_title,t.toast_body_title):o.displayToast("error",t.toast_header_title,t.toast_body_title)}catch(t){console.log(t)}},complete:function(){n.prop("disabled",!1).html(a.html)},error:function(t){console.error(t)}})}))},dismissPlaceholdersTip:function(){t(document).on("click","#joinotify_dismiss_placeholders_tip",(function(o){o.preventDefault(),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_dismiss_placeholders_tip"},success:function(t){e.debug_mode&&console.log(t)},error:function(t){console.log(t)}})}))},fetchAllGroups:function(){t(document).on("click","#joinotify_fetch_all_groups",(function(i){i.preventDefault(),t("#joinotify_fetch_all_groups_container").hasClass("content-loaded")||t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_fetch_all_groups",sender:t(".offcanvas.show").find(".get-whatsapp-phone-sender").val()},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?t("#joinotify_fetch_all_groups_container").addClass("content-loaded").find(".modal-body").html(i.groups_details_html):(t("#joinotify_fetch_all_groups_container").find(".btn-close").click(),o.displayToast("error",i.toast_header_title,i.toast_body_title))}catch(t){console.log(t)}},error:function(t){console.error(t)}})})),t(document).on("click",".get-group-id",(function(){var o=t(this),i=o.data("group-id");navigator.clipboard.writeText(i).then((function(){o.append(`<div class="confirm-copy-ui active">\n\t\t\t\t\t\t<svg class="icon icon-lg icon-white me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M9.999 13.587 7.7 11.292l-1.412 1.416 3.713 3.705 6.706-6.706-1.414-1.414z"></path></svg>\n\t\t\t\t\t\t<span>${e.i18n.copy_group_id}</span>\n\t\t\t\t\t</div>`),setTimeout((()=>{o.find(".confirm-copy-ui").removeClass("active")}),800),setTimeout((()=>{o.find(".confirm-copy-ui").remove()}),1e3)})).catch((function(t){console.error("Error on copy group ID: "+t)}))}))},saveActionSettings:function(){t(document).on("shown.bs.modal",".modal.show",(function(){var i=t(this),n=i.find(".save-action-edit").data("action"),a=o.getActionData(n,i);e.dev_mode&&console.log("Pre populated data: ",a),i.data("initial_data",JSON.stringify(a));let s=i.find(".search-products");if("condition"===i.find(".save-action-edit").data("action")&&"products_purchased"===i.find(".get-condition").val()){let o=s.attr("data-selected-products"),i=[];try{i=o?JSON.parse(o):[]}catch(t){console.error("Error parsing data-selected-products:",t)}let n=i.map((t=>t.id.toString()));s[0].selectize||s.selectize({plugins:{remove_button:{title:e.i18n.remove_product_selectize}},delimiter:",",persist:!1,maxItems:null,valueField:"id",labelField:"product_title",searchField:["product_title"],options:i,create:!1,render:{option:function(t,e){return`<div class="option" data-value="${e(t.id)}">${e(t.product_title)}</div>`}},load:function(o,i){if(o.length<3)return i();let n=this;n.$wrapper.append('<span class="spinner-border spinner-border-sm specific-search-spinner"></span>'),n.$wrapper.addClass("loading"),t.ajax({url:e.ajax_url,type:"POST",dataType:"json",data:{action:"joinotify_get_woo_products",search_query:o},success:function(t){n.$wrapper.find(".specific-search-spinner").remove(),n.$wrapper.removeClass("loading"),i(t)},error:function(){n.$wrapper.find(".specific-search-spinner").remove(),n.$wrapper.removeClass("loading"),i()}})}});let a=s[0].selectize;a&&(a.clearOptions(),i.forEach((t=>{a.options[t.id]||a.addOption({id:t.id,product_title:t.title})})),a.setValue(n),a.refreshOptions(!1))}let d=i.find(".save-action-edit");"snippet_php"===d.data("action")&&d.prop("disabled",!0)})),t(document).on("input change",".modal.show :input",(function(){var e=t(this).closest(".modal.show"),i=e.find(".save-action-edit").data("action"),n=o.getActionData(i,e),a=JSON.stringify(n)!==e.data("initial_data");let s=e.find(".save-action-edit");"snippet_php"===s.data("action")&&s.prop("disabled",!a)})),t(document).on("click",".save-action-edit",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n),s=n.data("action"),d=n.data("action-id"),r=o.getActionData(s,".modal.show");e.debug_mode&&console.log(r),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_save_action_edition",post_id:o.getParamByName("id"),action_id:d,new_action_data:JSON.stringify(r)},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?(t(".modal.show").find(".btn-close").click(),t("#joinotify_builder_funnel").children(".funnel-trigger-group").html(i.workflow_content),t(document).trigger("updatedWorkflow"),o.displayToast("success",i.toast_header_title,i.toast_body_title)):o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}},complete:function(){n.prop("disabled",!1).html(a.html)}})}))},codeEditor:function(){t(".joinotify-code-editor").each((function(){let e=this;if(!t(e).hasClass("initiliazed-editor")){var o=CodeMirror.fromTextArea(e,{mode:"application/x-httpd-php",theme:"dracula",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,indentUnit:4,tabSize:4,autoRefresh:!0});t(e).addClass("initiliazed-editor"),""===o.getValue().trim()?o.setValue("<?php\n\n"):o.setValue(e.value),o.on("change",(function(){let i=o.getValue();i=i.replace(/\\/g,"\\\\"),e.value=i,t(e).trigger("change")})),setTimeout((()=>{let o=t(e).next(".CodeMirror");if(o.length>0){let i=t('<div class="joinotify-resize-code-area"><svg class="icon-sm icon-dark opacity-75" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"></path></svg></div>');o.after(i);let n=!1,a=0,s=0;function d(t){if(!n)return;let e=t.clientY-a,i=s+e;i<100&&(i=100),o.css("height",i+"px"),o.find(".CodeMirror-scroll").css("height",i+"px")}function r(){n=!1,t(document).off("mousemove",d),t(document).off("mouseup",r)}i.on("mousedown",(function(e){e.preventDefault(),n=!0,a=e.clientY,s=o.outerHeight(),t(document).on("mousemove",d),t(document).on("mouseup",r)}))}else console.warn("CodeMirror element not found for textarea:",e)}),300)}}))},codePreview:function(){t(".joinotify-code-preview").each((function(){let e=CodeMirror.fromTextArea(this,{mode:"application/x-httpd-php",theme:"dracula",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,indentUnit:4,tabSize:4,readOnly:"nocursor"});t(this).addClass("initiliazed-preview"),e.setSize("100%","auto"),t(e.getWrapperElement()).addClass("preview")}))},saveTriggerSettings:function(){t(document).on("click",".save-trigger-settings",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n),s=n.data("trigger"),d=n.data("trigger-id"),r={};"woocommerce_order_status_changed"===s?r={order_status:t(".modal.show").find(".set-trigger-settings.order-status").val()}:"wpforms_process_complete"===s||"wpforms_paypal_standard_process_complete"===s?r={form_id:t(".modal.show").find(".set-trigger-settings.wpforms-form-id").val()}:"change_post_status"!==s&&"transition_post_status"!==s||(r={post_status:t(".modal.show").find(".set-trigger-settings.post-status").val()}),t.ajax({url:e.ajax_url,method:"POST",data:{action:"joinotify_save_trigger_settings",post_id:o.getParamByName("id"),trigger_id:d,settings:JSON.stringify(r)},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(i){e.debug_mode&&console.log(i);try{"success"===i.status?(t(".modal.show").find(".btn-close").click(),o.displayToast("success",i.toast_header_title,i.toast_body_title)):o.displayToast("error",i.toast_header_title,i.toast_body_title)}catch(t){console.log(t)}},complete:function(){n.prop("disabled",!1).html(a.html)}})}))},emojiPicker:function(){var o=e.i18n.emoji_picker;t(".add-emoji-picker").hasClass("emoji-initialized")||(setTimeout((()=>{t(".add-emoji-picker").emojioneArea({tones:!0,hidePickerOnBlur:!0,recentEmojis:!0,pickerPosition:"bottom",searchPlaceholder:o.placeholder,buttonTitle:o.button_title,filters:{tones:{title:o.filters.tones_title},recent:{title:o.filters.recent_title},smileys_people:{title:o.filters.smileys_people_title},animals_nature:{title:o.filters.animals_nature_title},food_drink:{title:o.filters.food_drink_title},activity:{title:o.filters.activity_title},travel_places:{title:o.filters.travel_places_title},objects:{title:o.filters.objects_title},symbols:{title:o.filters.symbols_title},flags:{title:o.filters.flags_title}}})}),600),t(".add-emoji-picker").addClass("emoji-initialized")),t(document).on("keyup change",".emojionearea-editor",(function(){var e=t(this).html();t(this).closest(".add-emoji-picker").val(e)}))},searchWooProducts:function(){setTimeout((()=>{t(".search-products").each((function(){let i=t(this),n=i.attr("data-selected-products"),a=[];try{a=n?JSON.parse(n):[]}catch(t){console.error("Error parsing data-selected-products:",t)}let s=a.map((t=>t.id.toString()));if(i[0].selectize){let t=i[0].selectize;t.destroy(),t.clearOptions(),a.forEach((e=>{t.options[e.id]||t.addOption({id:e.id,product_title:e.title})})),t.setValue(s),t.refreshOptions()}let d=i.selectize({plugins:{remove_button:{title:e.i18n.remove_product_selectize}},delimiter:",",persist:!1,valueField:"id",labelField:"product_title",searchField:"product_title",create:!1,maxItems:null,options:a,items:s,render:{option:function(t,e){return`<div class="option" data-value="${e(t.id)}">${e(t.product_title)}</div>`}},load:function(o,i){if(o.length<3)return i();let n=this;n.$wrapper.append('<span class="spinner-border spinner-border-sm specific-search-spinner"></span>'),n.$wrapper.addClass("loading"),t.ajax({url:e.ajax_url,type:"POST",dataType:"json",data:{action:"joinotify_get_woo_products",search_query:o},success:function(t){n.$wrapper.find(".specific-search-spinner").remove(),n.$wrapper.removeClass("loading"),i(t)},error:function(){n.$wrapper.find(".specific-search-spinner").remove(),n.$wrapper.removeClass("loading"),i()}})}})[0].selectize;d.on("item_add",(function(t){let n=parseInt(t),a=d.options[n],s=a?a.product_title:"";o.purchasedProducts.some((t=>t.id===n))||o.purchasedProducts.push({id:n,title:s}),i.attr("data-selected-products",JSON.stringify(o.purchasedProducts)),e.dev_mode&&console.log(o.purchasedProducts)})),d.on("item_remove",(function(t){let n=parseInt(t);o.purchasedProducts=o.purchasedProducts.filter((t=>t.id!==n)),i.attr("data-selected-products",JSON.stringify(o.purchasedProducts)),e.dev_mode&&console.log(o.purchasedProducts)})),setTimeout((()=>{d.setValue(s),d.refreshOptions()}),200)}))}),500)},installModule:function(){t(".install-required-plugin").on("click",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n);let s=n.data("download-url"),d=n.data("required-plugin");t.ajax({type:"POST",url:e.ajax_url,data:{action:"joinotify_install_modules",plugin_url:s,plugin_slug:d},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(t){"success"===t.status?(n.removeClass("btn-primary").addClass("btn-success"),n.html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="m10 15.586-3.293-3.293-1.414 1.414L10 18.414l9.707-9.707-1.414-1.414z"></path></svg>'),o.displayToast("success",t.toast_header_title,t.toast_body_title),setTimeout((function(){location.reload()}),1e3)):(n.html(a.html),o.displayToast("error",t.toast_header_title,t.toast_body_title)),n.prop("disabled",!1)},error:function(t){n.prop("disabled",!1).html(a.html),alert("Error installing the plugin: "+t.responseText)}})}))},activeModule:function(){t(".activate-plugin").on("click",(function(i){i.preventDefault();let n=t(this);var a=o.keepButtonState(n);let s=n.data("plugin-slug");t.ajax({type:"POST",url:e.ajax_url,data:{action:"joinotify_activate_plugin",plugin_slug:s},beforeSend:function(){n.prop("disabled",!0).html('<span class="spinner-border spinner-border-sm"></span>')},success:function(t){"success"===t.status?(n.removeClass("btn-primary").addClass("btn-success"),n.html('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#fff" d="m10 15.586-3.293-3.293-1.414 1.414L10 18.414l9.707-9.707-1.414-1.414z"></path></svg>'),o.displayToast("success",t.toast_header_title,t.toast_body_title),location.reload()):(n.html(a.html),o.displayToast("error",t.toast_header_title,t.toast_body_title))},error:function(t){n.html(a.html),console.error(t)}})}))},updateMediaPreview:function(){function e(t,e){switch(t){case"image":return`<img class="funnel-media image" src="${e}">`;case"video":return`<video class="funnel-media video" controls width="250"><source src="${e}"/></video>`;case"document":return`<embed class="funnel-media document" src="${e}" frameborder="0" allowfullscreen>`;case"audio":return`<audio class="funnel-media audio" controls><source src="${e}"></audio>`}}t(document).on("change input",".modal.show .get-whatsapp-media-type",(function(){let o=t(".modal.show").find(".get-whatsapp-media-url").val(),i=e(t(this).val(),o);t(".modal.show").find(".preview-whatsapp-message-sender").html(i)})),t(document).on("change input",".modal.show .get-whatsapp-media-url",(function(){let o=t(this).val(),i=e(t(".modal.show").find(".get-whatsapp-media-type").val(),o);t(".modal.show").find(".preview-whatsapp-message-sender").html(i)}))},detectOfflineConnection:function(){function t(){navigator.onLine||o.displayToast("warning",e.i18n.offline_toast_header,e.i18n.offline_toast_body)}t(),window.addEventListener("online",t),window.addEventListener("offline",t)},init:function(){t("body").addClass("joinotify-builder-workflows"),null===o.getParamByName("id")&&t(".joinotify-loader-container").addClass("d-none"),this.addTrigger(),this.workflowSteps(),this.downloadTemplates(),this.filterWorkflowTemplates(),this.triggerTabs(),this.loadWorkflowData(),this.uploadWorkflowTemplates(),this.onWorkflowReady(),this.onUpdatedWorkflow(),this.initBootstrapComponents(),this.installModule(),this.activeModule(),this.detectOfflineConnection()},onWorkflowReady:function(){t(document).on("workflowReady",(function(){o.saveTriggerSettings(),o.sidebarActions(),o.addAction(),o.removeAction(),o.saveActionSettings(),o.codeEditor(),o.codePreview(),o.correctTriggerSettingsModal(),o.emojiPicker(),o.dismissPlaceholdersTip(),o.fetchAllGroups(),o.searchWooProducts(),o.changeWorkflowStatus(),o.updateWorkflowTitle(),o.initBootstrapComponents(),o.adjustHeightCondition(),o.changeVisibilityForElements(),o.initDatePicker(),o.whatsappMessagePreview(),o.exportWorkflow(),o.openMediaLibrary(),o.runTestWorkflow(),o.validateInputCurrency(),o.updateMediaPreview()}))},onUpdatedWorkflow:function(){t(document).on("updatedWorkflow",(function(){o.changeVisibilityForElements(),o.codeEditor(),o.codePreview(),o.correctTriggerSettingsModal(),o.adjustHeightCondition(),o.validateInputCurrency(),o.emojiPicker(),o.searchWooProducts(),o.updateMediaPreview()}))}};jQuery(document).ready((function(t){o.init()}))}(jQuery);